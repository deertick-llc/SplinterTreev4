fix: prevent duplicate message processing

- Move processed_messages check to start of on_message handler
- Mark messages as processed immediately after check
- Save processed messages right after marking
- Remove redundant processed_messages operations

This change prevents messages from being processed multiple times by ensuring they are marked as processed before any handlers or cogs process them.
